#!/bin/bash -e

#nova-manage cell_v2 discover_hosts --verbose
#sudo systemctl restart devstack@q-l3
#sudo systemctl restart devstack@q-meta
echo "Wait 10s until services are up ⏲️"
# Countdown loop
for ((i = 10; i > 0; i--)); do
  echo -ne "Time remaining: $i seconds\033[0K\r" # \r moves the cursor back to the beginning of the line
  sleep 1
done

openstack service list
openstack endpoint list
openstack compute service list
openstack network agent list

net_id=$(openstack network show private -f json 2>/dev/null | jq -r .id | tr -d "\r\n")
image=$(openstack image list | awk '/cirros/ { print $4 }')

nova boot --image $image --flavor m1.medium \
  --nic net-id=$net_id testvm
echo "Wait 30s until server is comming up 😉"
# Countdown loop
for ((i = 30; i > 0; i--)); do
  echo -ne "Time remaining until VM comes up: $i seconds\033[0K\r" # \r moves the cursor back to the beginning of the line
  sleep 1
done

ip=$(openstack server show testvm -f json | jq -r '.addresses.private[0]')

echo "NOVA list 👀"
nova list
echo "show testvm 🖥️"
nova show testvm | grep ACTIVE
echo "console-log testvm 📜"
nova console-log testvm
echo "console-log testvm | grep $ip 🕸️"
nova console-log testvm | grep $ip
echo "delete testvm 💀"
nova delete testvm

#sudo journalctl --no-pager -n 300 -eu devstack@n-cpu
#sudo journalctl --no-pager -n 300 -eu devstack@q-agt
